<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TechPartner: Super App</title>
    
    <!-- LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.7/dayjs.min.js"></script>
    <!-- Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        tailwind.config = {
            theme: { extend: { colors: { primary: '#2563eb', dark: '#0f172a', money: '#10b981' } } }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        /* Timeline Styles */
        .timeline-line { position: absolute; left: 18px; top: 35px; bottom: 0; width: 2px; background: #e2e8f0; z-index: 0; }
        /* Image Preview */
        .img-thumb { width: 100%; height: 120px; object-fit: cover; border-radius: 8px; border: 1px solid #e2e8f0; }
        .receipt-card { background-image: radial-gradient(#f1f5f9 1px, transparent 1px); background-size: 10px 10px; }
        
        @media print {
            @page { size: A4 portrait; margin: 10mm; }
            body { background: white; }
            nav, .no-print, .tab-nav, .fab-add { display: none !important; }
            #view-assets, #view-activity, #view-finance { display: block !important; margin-bottom: 50px; }
        }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">
<!-- NAVBAR -->
    <nav class="bg-slate-900 text-white px-4 py-3 flex justify-between items-center shadow-lg z-30 no-print">
        <div class="flex items-center gap-3">
            <div class="bg-primary p-2 rounded-lg">
                <i class="fa-solid fa-robot text-lg"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg leading-none">TechPartner</h1>
                <p class="text-[10px] text-slate-400 uppercase tracking-widest mt-1">General & IT Assistant</p>
            </div>
        </div>
        
        <div class="flex gap-3">
            <!-- Sync Indicator -->
            <button onclick="app.syncData()" class="relative p-2 rounded-full hover:bg-slate-800 transition">
                <i class="fa-solid fa-cloud-arrow-down text-slate-300"></i>
                <span id="sync-badge" class="absolute top-1 right-1 w-2.5 h-2.5 bg-green-500 rounded-full border-2 border-slate-900"></span>
            </button>
            <button onclick="ui.showSettings()" class="p-2 rounded-full hover:bg-slate-800 transition">
                <i class="fa-solid fa-gear text-slate-300"></i>
            </button>
        </div>
    </nav>
<!-- TABS (Scrollable) -->
    <div class="bg-white border-b flex overflow-x-auto tab-nav no-print shadow-sm z-20">
        <button onclick="ui.switchTab('assets')" id="tab-assets" class="flex-1 min-w-[100px] py-3 text-sm font-bold border-b-2 border-primary text-primary transition">
            <i class="fa-solid fa-box mr-1"></i> Aset
        </button>
        <button onclick="ui.switchTab('activity')" id="tab-activity" class="flex-1 min-w-[100px] py-3 text-sm font-medium text-slate-500 hover:text-slate-800 border-b-2 border-transparent transition">
            <i class="fa-solid fa-clock-rotate-left mr-1"></i> Jurnal
        </button>
        <button onclick="ui.switchTab('finance')" id="tab-finance" class="flex-1 min-w-[100px] py-3 text-sm font-medium text-slate-500 hover:text-slate-800 border-b-2 border-transparent transition">
            <i class="fa-solid fa-wallet mr-1"></i> Keuangan
        </button>
    </div>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-y-auto p-4 bg-slate-50 relative">
<!-- VIEW: ASSETS -->
        <div id="view-assets" class="block pb-24">
            <!-- Search & Actions -->
            <div class="flex gap-2 mb-4 sticky top-0 bg-slate-50 z-10 py-2 no-print">
                <div class="relative flex-1">
                    <i class="fa-solid fa-search absolute left-3 top-3 text-slate-400"></i>
                    <input type="text" id="searchAsset" onkeyup="app.renderAssets()" placeholder="Cari aset..." class="w-full pl-9 pr-3 py-2 border rounded-lg shadow-sm focus:ring-2 focus:ring-primary outline-none">
                </div>
                <button onclick="ui.showAssetModal()" class="bg-primary text-white w-10 h-10 rounded-lg shadow-md flex items-center justify-center hover:bg-blue-600">
                    <i class="fa-solid fa-plus"></i>
                </button>
            </div>

            <!-- Asset Grid -->
            <div id="asset-list" class="grid grid-cols-1 gap-3">
                <!-- JS Populated -->
            </div>
            <div class="mt-4 text-center text-xs text-slate-400">Total Aset Tercatat: <span id="stat-total-asset">0</span></div>
        </div>
<!-- VIEW: ACTIVITY LOG -->
        <div id="view-activity" class="hidden pb-24 max-w-2xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-xl font-bold text-slate-800">Jurnal Harian</h2>
                    <p class="text-xs text-slate-500" id="current-date-log">Today</p>
                </div>
                <button onclick="ui.showActivityModal()" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-slate-700">
                    <i class="fa-solid fa-pen-to-square mr-1"></i> Catat
                </button>
            </div>

            <!-- Timeline Container -->
            <div id="activity-list" class="space-y-6 relative">
                <!-- JS Populated Timeline -->
            </div>
        </div>
<!-- VIEW: FINANCE -->
        <div id="view-finance" class="hidden pb-24 max-w-2xl mx-auto">
            <!-- Dashboard Card -->
            <div class="bg-gradient-to-r from-emerald-500 to-teal-600 rounded-2xl p-5 text-white shadow-lg mb-6 relative overflow-hidden">
                <i class="fa-solid fa-coins absolute -right-4 -bottom-4 text-8xl opacity-10"></i>
                <p class="text-emerald-100 text-xs font-bold uppercase tracking-wider">Total Belanja Bulan Ini</p>
                <h2 class="text-3xl font-black mt-1" id="finance-total">Rp 0</h2>
                <div class="mt-4 flex gap-2">
                    <button onclick="ui.showFinanceModal()" class="bg-white text-emerald-600 px-4 py-1.5 rounded-lg text-xs font-bold shadow hover:bg-emerald-50">
                        <i class="fa-solid fa-plus mr-1"></i> Catat Belanja
                    </button>
                    <button onclick="app.exportFinance()" class="bg-emerald-700 text-white px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-emerald-800">
                        <i class="fa-solid fa-file-excel mr-1"></i> Laporan
                    </button>
                </div>
            </div>

            <h3 class="font-bold text-slate-700 mb-3 ml-1">Riwayat Transaksi</h3>
            <div id="finance-list" class="space-y-3">
                <!-- JS Populated List -->
            </div>
        </div>
    </main>
<!-- MODAL: ASSET (Simplified for Android) -->
    <div id="modal-asset" class="fixed inset-0 bg-black/50 hidden z-50 items-end sm:items-center justify-center p-0 sm:p-4 no-print"><div class="bg-white w-full sm:max-w-md rounded-t-2xl sm:rounded-2xl p-5 max-h-[90vh] overflow-y-auto animate-slide-up"><h3 class="font-bold text-lg mb-4">Data Aset</h3><form onsubmit="app.saveAsset(event)"><input type="hidden" id="asset-id"><div class="grid grid-cols-2 gap-2 mb-3"><label class="border p-3 rounded-lg text-center cursor-pointer has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500"><input type="radio" name="cat" value="AC" checked class="hidden"><i class="fa-solid fa-wind block text-xl mb-1"></i><span class="text-xs font-bold">AC</span></label><label class="border p-3 rounded-lg text-center cursor-pointer has-[:checked]:bg-yellow-50 has-[:checked]:border-yellow-500"><input type="radio" name="cat" value="Light" class="hidden"><i class="fa-regular fa-lightbulb block text-xl mb-1"></i><span class="text-xs font-bold">Lampu</span></label></div><input id="asset-loc" placeholder="Lokasi (cth: R. Meeting)" class="w-full border p-3 rounded-lg mb-3" required><input id="asset-model" placeholder="Merk/Model" class="w-full border p-3 rounded-lg mb-3"><select id="asset-cond" class="w-full border p-3 rounded-lg mb-3"><option value="Normal">Normal</option><option value="Rusak">Rusak</option><option value="Perlu Servis">Perlu Servis</option></select><textarea id="asset-issue" placeholder="Keluhan..." class="w-full border p-3 rounded-lg mb-4 h-20"></textarea><div class="flex gap-2"><button type="button" onclick="ui.closeModal('modal-asset')" class="flex-1 py-3 text-slate-500">Batal</button><button type="submit" class="flex-1 bg-primary text-white rounded-lg font-bold">Simpan</button></div></form></div></div>

    <!-- MODAL: ACTIVITY (NEW - With Photo) -->
    <div id="modal-activity" class="fixed inset-0 bg-black/50 hidden z-50 items-end sm:items-center justify-center p-0 sm:p-4 no-print">
        <div class="bg-white w-full sm:max-w-md rounded-t-2xl sm:rounded-2xl p-5 max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-lg mb-4">Catat Kegiatan</h3>
            <form onsubmit="app.saveActivity(event)">
                <input type="text" id="act-title" placeholder="Judul Kegiatan (cth: Perbaikan Jaringan)" class="w-full border p-3 rounded-lg mb-3 font-bold" required>
                
                <div class="flex gap-2 mb-3">
                    <input type="time" id="act-time" class="border p-2 rounded-lg w-24" required>
                    <select id="act-tag" class="border p-2 rounded-lg flex-1 bg-white">
                        <option value="Umum">Umum</option>
                        <option value="IT">IT Support</option>
                        <option value="GA">Maintenance GA</option>
                        <option value="Rapat">Meeting/Briefing</option>
                    </select>
                </div>

                <textarea id="act-desc" placeholder="Deskripsi detail..." class="w-full border p-3 rounded-lg mb-3 h-24 text-sm"></textarea>

                <!-- Photo Upload -->
                <div class="mb-4">
                    <label class="block text-xs font-bold text-slate-500 mb-1">Foto Bukti (Opsional)</label>
                    <input type="file" id="act-photo" accept="image/*" class="text-sm text-slate-500 w-full" onchange="ut.previewImage(this, 'act-preview')">
                    <img id="act-preview" class="hidden mt-2 w-full h-32 object-cover rounded-lg border">
                </div>

                <div class="flex gap-2">
                    <button type="button" onclick="ui.closeModal('modal-activity')" class="flex-1 py-3 text-slate-500">Batal</button>
                    <button type="submit" class="flex-1 bg-slate-800 text-white rounded-lg font-bold">Simpan Log</button>
                </div>
            </form>
        </div>
    </div>
<!-- MODAL: FINANCE (NEW - With Receipt) -->
    <div id="modal-finance" class="fixed inset-0 bg-black/50 hidden z-50 items-end sm:items-center justify-center p-0 sm:p-4 no-print">
        <div class="bg-white w-full sm:max-w-md rounded-t-2xl sm:rounded-2xl p-5 max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-lg mb-4 text-emerald-700">Catat Pengeluaran</h3>
            <form onsubmit="app.saveFinance(event)">
                <input type="text" id="fin-item" placeholder="Nama Barang (cth: Kabel LAN 1 Roll)" class="w-full border p-3 rounded-lg mb-3" required>
                
                <div class="relative mb-3">
                    <span class="absolute left-3 top-3 text-slate-400 font-bold">Rp</span>
                    <input type="number" id="fin-cost" placeholder="0" class="w-full border p-3 pl-10 rounded-lg font-mono font-bold text-lg" required>
                </div>

                <!-- Receipt Upload -->
                <div class="mb-4 bg-slate-50 p-3 rounded-lg border border-dashed border-slate-300">
                    <label class="block text-xs font-bold text-slate-500 mb-2 text-center">Foto Bon / Nota</label>
                    <input type="file" id="fin-photo" accept="image/*" class="hidden" onchange="ut.previewImage(this, 'fin-preview')">
                    <label for="fin-photo" class="block w-full text-center py-2 bg-white border rounded cursor-pointer hover:bg-slate-100 text-sm"><i class="fa-solid fa-camera mr-1"></i> Ambil Foto</label>
                    <img id="fin-preview" class="hidden mt-2 w-full h-40 object-contain bg-white rounded border">
                </div>

                <div class="flex gap-2">
                    <button type="button" onclick="ui.closeModal('modal-finance')" class="flex-1 py-3 text-slate-500">Batal</button>
                    <button type="submit" class="flex-1 bg-emerald-600 text-white rounded-lg font-bold">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: SETTINGS -->
    <div id="modal-settings" class="fixed inset-0 bg-black/80 hidden z-50 items-center justify-center p-4 no-print">
        <div class="bg-white w-full max-w-sm rounded-xl p-5">
            <h3 class="font-bold mb-4">Koneksi Database</h3>
            <input id="conf-owner" placeholder="GitHub Username" class="w-full border p-2 mb-2 rounded text-sm">
            <input id="conf-repo" placeholder="Repo Name" class="w-full border p-2 mb-2 rounded text-sm">
            <input id="conf-token" type="password" placeholder="GitHub Token (ghp_...)" class="w-full border p-2 mb-4 rounded text-sm">
            <button onclick="app.saveSettings()" class="w-full bg-primary text-white py-2 rounded font-bold">Connect</button>
            <button onclick="ui.closeModal('modal-settings')" class="w-full mt-2 text-sm text-slate-500">Close</button>
        </div>
    </div>
<!-- LOGIC -->
    <script>
        // --- UTILS & IMAGE COMPRESSOR ---
        const ut = {
            id: () => Date.now().toString(36) + Math.random().toString(36).substr(2),
            formatRp: (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(n),
            // GitHub API safe encoder
            b64Enc: (str) => btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, (m, p1) => String.fromCharCode('0x' + p1))),
            b64Dec: (str) => decodeURIComponent(atob(str).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')),
            
            // Image Preview
            previewImage: (input, imgId) => {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = document.getElementById(imgId);
                        img.src = e.target.result;
                        img.classList.remove('hidden');
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            },

            // SMART COMPRESSOR: Resize image to max 800px width to save space
            compressImage: (file) => {
                return new Promise((resolve) => {
                    if (!file) { resolve(null); return; }
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 800; // Limit width
                            const scaleSize = MAX_WIDTH / img.width;
                            canvas.width = MAX_WIDTH;
                            canvas.height = img.height * scaleSize;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            // Compress to JPEG 0.7 quality
                            resolve(canvas.toDataURL('image/jpeg', 0.7)); 
                        }
                    }
                });
            }
        };

        const state = {
            // New Database Structure
            db: { assets: [], activities: [], finances: [] },
            sha: null,
            config: { owner: localStorage.getItem('gh_owner')||'', repo: localStorage.getItem('gh_repo')||'', token: localStorage.getItem('gh_token')||'', path: 'data/db_partner.json' }
        };
const app = {
            init: () => {
                document.getElementById('current-date-log').innerText = dayjs().format('dddd, D MMMM YYYY');
                if(state.config.token) app.syncData(); else ui.showSettings();
            },

            // --- ASSET LOGIC ---
            saveAsset: async (e) => {
                e.preventDefault();
                const id = document.getElementById('asset-id').value || ut.id();
                const newData = {
                    id, 
                    cat: document.querySelector('input[name="cat"]:checked').value,
                    loc: document.getElementById('asset-loc').value,
                    model: document.getElementById('asset-model').value,
                    cond: document.getElementById('asset-cond').value,
                    issue: document.getElementById('asset-issue').value,
                    date: dayjs().format('YYYY-MM-DD')
                };
                
                const idx = state.db.assets.findIndex(x => x.id === id);
                if(idx >= 0) state.db.assets[idx] = newData; else state.db.assets.push(newData);
                
                ui.closeModal('modal-asset');
                app.renderAssets();
                app.pushToGitHub(`Update Aset: ${newData.loc}`);
            },

            deleteAsset: (id) => {
                if(confirm('Hapus aset ini?')) {
                    state.db.assets = state.db.assets.filter(x => x.id !== id);
                    app.renderAssets();
                    app.pushToGitHub('Hapus Aset');
                }
            },
// --- ACTIVITY LOGIC ---
            saveActivity: async (e) => {
                e.preventDefault();
                // Button Loading State
                const btn = e.target.querySelector('button[type="submit"]');
                const oldText = btn.innerText; btn.innerText = "Compressing..."; btn.disabled = true;

                const photoFile = document.getElementById('act-photo').files[0];
                const photoBase64 = await ut.compressImage(photoFile); // Compress Logic

                const act = {
                    id: ut.id(),
                    title: document.getElementById('act-title').value,
                    time: document.getElementById('act-time').value,
                    tag: document.getElementById('act-tag').value,
                    desc: document.getElementById('act-desc').value,
                    img: photoBase64, // Simpan string gambar
                    date: dayjs().format('YYYY-MM-DD')
                };

                state.db.activities.unshift(act); // Add to top
                ui.closeModal('modal-activity');
                app.renderActivity();
                btn.innerText = oldText; btn.disabled = false;
                app.pushToGitHub(`Log: ${act.title}`);
            },

            // --- FINANCE LOGIC ---
            saveFinance: async (e) => {
                e.preventDefault();
                const btn = e.target.querySelector('button[type="submit"]');
                btn.innerText = "Processing..."; btn.disabled = true;

                const photoFile = document.getElementById('fin-photo').files[0];
                const photoBase64 = await ut.compressImage(photoFile);

                const fin = {
                    id: ut.id(),
                    item: document.getElementById('fin-item').value,
                    cost: parseInt(document.getElementById('fin-cost').value),
                    img: photoBase64,
                    date: dayjs().format('YYYY-MM-DD')
                };

                state.db.finances.unshift(fin);
                ui.closeModal('modal-finance');
                app.renderFinance();
                btn.innerText = oldText; btn.disabled = false;
                app.pushToGitHub(`Belanja: ${fin.item}`);
            },
            
            exportFinance: () => {
                const data = state.db.finances.map(f => ({ Item: f.item, Harga: f.cost, Tgl: f.date }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Keuangan");
                XLSX.writeFile(wb, `Laporan_Keuangan_${dayjs().format('YYYY-MM')}.xlsx`);
            },
// --- RENDERERS ---
            renderAssets: () => {
                const term = document.getElementById('searchAsset').value.toLowerCase();
                const list = document.getElementById('asset-list');
                const filtered = state.db.assets.filter(a => a.loc.toLowerCase().includes(term));
                document.getElementById('stat-total-asset').innerText = state.db.assets.length;
                list.innerHTML = filtered.map(a => `
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex justify-between items-start">
                        <div>
                            <div class="font-bold text-slate-800">${a.loc}</div>
                            <div class="text-xs text-slate-500"><i class="fa-solid ${a.cat==='AC'?'fa-wind':'fa-lightbulb'}"></i> ${a.model||'-'}</div>
                            <div class="mt-1 text-xs px-2 py-0.5 rounded inline-block ${a.cond==='Normal'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}">${a.cond}</div>
                        </div>
                        <button onclick="app.deleteAsset('${a.id}')" class="text-slate-300 hover:text-red-500"><i class="fa-solid fa-trash"></i></button>
                    </div>`).join('');
            },

            renderActivity: () => {
                const list = document.getElementById('activity-list');
                list.innerHTML = state.db.activities.map(a => `
                    <div class="relative pl-8">
                        <div class="timeline-line"></div>
                        <div class="absolute left-0 top-0 w-8 text-xs font-bold text-slate-400 text-center">${a.time}</div>
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 relative z-10">
                            <div class="flex justify-between mb-2">
                                <span class="text-xs font-bold px-2 py-0.5 rounded bg-blue-50 text-blue-600">${a.tag}</span>
                                <span class="text-[10px] text-slate-400">${a.date}</span>
                            </div>
                            <h4 class="font-bold text-slate-800">${a.title}</h4>
                            <p class="text-sm text-slate-600 mt-1 whitespace-pre-line">${a.desc}</p>
                            ${a.img ? `<div class="mt-3"><img src="${a.img}" class="img-thumb" onclick="window.open(this.src)"></div>` : ''}
                        </div>
                    </div>`).join('');
            },

            renderFinance: () => {
                const list = document.getElementById('finance-list');
                const total = state.db.finances.reduce((acc, curr) => acc + (curr.cost || 0), 0);
                document.getElementById('finance-total').innerText = ut.formatRp(total);
                
                list.innerHTML = state.db.finances.map(f => `
                    <div class="receipt-card bg-white p-3 rounded-lg border border-slate-200 flex gap-3 items-center">
                        ${f.img ? `<img src="${f.img}" class="w-12 h-12 rounded object-cover border cursor-pointer" onclick="window.open(this.src)">` : '<div class="w-12 h-12 bg-slate-100 rounded flex items-center justify-center text-slate-300"><i class="fa-solid fa-receipt"></i></div>'}
                        <div class="flex-1">
                            <div class="font-bold text-slate-800">${f.item}</div>
                            <div class="text-xs text-slate-500">${f.date}</div>
                        </div>
                        <div class="font-mono font-bold text-emerald-600">${ut.formatRp(f.cost)}</div>
                    </div>`).join('');
            },

            // --- SYNC ---
            saveSettings: () => {
                state.config.owner = document.getElementById('conf-owner').value; state.config.repo = document.getElementById('conf-repo').value; state.config.token = document.getElementById('conf-token').value;
                localStorage.setItem('gh_owner', state.config.owner); localStorage.setItem('gh_repo', state.config.repo); localStorage.setItem('gh_token', state.config.token);
                ui.closeModal('modal-settings'); app.syncData();
            },
            syncData: async () => {
                const {owner,repo,path,token} = state.config; if(!token) return;
                const badge = document.getElementById('sync-badge'); badge.classList.replace('bg-green-500','bg-yellow-500');
                try {
                    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, { headers: {'Authorization': `token ${token}`} });
                    if(res.ok) {
                        const json = await res.json(); state.sha = json.sha;
                        const data = JSON.parse(ut.b64Dec(json.content));
                        state.db = { ...state.db, ...data }; // Merge structure
                    } else if(res.status===404) { await app.pushToGitHub("Init Partner DB"); }
                    app.renderAssets(); app.renderActivity(); app.renderFinance();
                    badge.classList.replace('bg-yellow-500','bg-green-500');
                } catch(e) { badge.classList.replace('bg-yellow-500','bg-red-500'); Swal.fire('Error', e.message, 'error'); }
            },
            pushToGitHub: async (msg) => {
                const {owner,repo,path,token} = state.config;
                const badge = document.getElementById('sync-badge'); badge.classList.replace('bg-green-500','bg-yellow-500');
                try {
                    const body = { message: msg, content: ut.b64Enc(JSON.stringify(state.db)), sha: state.sha };
                    const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, { method: 'PUT', headers: {'Authorization': `token ${token}`}, body: JSON.stringify(body) });
                    if(res.ok) { const json = await res.json(); state.sha = json.content.sha; badge.classList.replace('bg-yellow-500','bg-green-500'); }
                } catch(e) { badge.classList.replace('bg-yellow-500','bg-red-500'); }
            }
        };

        const ui = {
            switchTab: (t) => {
                ['assets','activity','finance'].forEach(x => {
                    document.getElementById(`view-${x}`).classList.add('hidden');
                    document.getElementById(`tab-${x}`).className = "flex-1 min-w-[100px] py-3 text-sm font-medium text-slate-500 hover:text-slate-800 border-b-2 border-transparent transition";
                });
                document.getElementById(`view-${t}`).classList.remove('hidden');
                document.getElementById(`tab-${t}`).className = "flex-1 min-w-[100px] py-3 text-sm font-bold border-b-2 border-primary text-primary transition";
            },
            showAssetModal: () => { document.getElementById('assetForm').reset(); document.getElementById('modal-asset').classList.remove('hidden'); document.getElementById('modal-asset').classList.add('flex'); },
            showActivityModal: () => { document.getElementById('modal-activity').classList.remove('hidden'); document.getElementById('modal-activity').classList.add('flex'); },
            showFinanceModal: () => { document.getElementById('modal-finance').classList.remove('hidden'); document.getElementById('modal-finance').classList.add('flex'); },
            showSettings: () => { 
                document.getElementById('conf-owner').value = state.config.owner; document.getElementById('conf-repo').value = state.config.repo; document.getElementById('conf-token').value = state.config.token;
                document.getElementById('modal-settings').classList.remove('hidden'); document.getElementById('modal-settings').classList.add('flex'); 
            },
            closeModal: (id) => { document.getElementById(id).classList.add('hidden'); document.getElementById(id).classList.remove('flex'); }
        };

        document.addEventListener('DOMContentLoaded', app.init);
    </script>
</body>
</html>